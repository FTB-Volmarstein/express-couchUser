{"name":"Express-couchuser","tagline":"A express module for CouchDb based User Authentication Module","body":"# express-user-couchdb - ExpressCouchDb Module\r\n\r\n[![Build Status](https://secure.travis-ci.org/twilson63/express-couchUser.png)](http://travis-ci.org/twilson63/express-couchUser)\r\n\r\nThis module is a authentication lib built on top of couch's user model.\r\n\r\n## requirements\r\n\r\n* couchdb\r\n* nodejs\r\n\r\n## init example\r\n\r\n``` js\r\nvar couchUser = require('express-couchUser');\r\nvar express = require('express');\r\nvar app = express();\r\n\r\n// Required for session storage\r\napp.use(express.cookieParser());\r\napp.use(express.session({ secret: 'Use something else here.'}));\r\n\r\napp.configure(function() {\r\n  app.use(couchUser({\r\n    users: 'http://localhost:5984/_users',\r\n    email: {\r\n      ...\r\n    },\r\n    adminRoles: [ 'admin' ],\r\n    validateUser: function(data, cb) {...}\r\n  }));\r\n});\r\n\r\n```\r\nThe optional adminRoles attribute allows you to specify one or more administrative roles that are allowed to add, update, and delete users.\r\n\r\nThe optional validateUser allows you to specify extra validation other than username/password. For example, checking for greater than x number of login attempts. The first argument data is an object that has request, user, and headers fields. The reason the callback pattern is used to pass out the result is that you can do async calls within this function (like check another database, etc).\r\n\r\nExample validateUser function.\r\n\r\n``` js\r\nvalidateUser: function(data, cb) {\r\n  var MAX_FAILED_LOGIN = 5;\r\n  var req = data.req;     //all the fields in data is captured from /api/user/signin callback function\r\n  var user = data.user;\r\n  var headers = data.headers;\r\n  var outData = {         // This object will be attached to the session \r\n    userInfo: \"userAge\"   // req.session.userInfo will be \"userAge\"\r\n  };\r\n\r\n  if(data.user.failedLogin > MAX_FAILED_LOGIN) {\r\n    //fails check\r\n    var errorPayload = {\r\n      statusCode: 403,                           //if not included will default to 401 \r\n      message: 'Exceeded fail login attempts',   //if not included will default to 'Invalid User Login'\r\n      error: 'Forbidden'                         //if not included will default 'unauthorized'\r\n    }\r\n    cb(errorPayload);\r\n  } else {\r\n    //passess check\r\n    cb(null, outData);\r\n  }\r\n}\r\n```\r\n\r\n## Initialize CouchDb\r\n\r\nBefore you can use this module, you need to run a setup process to add the required views to the couchDb Users table, there is an `init.js` file that does this for you.  You can include it in your Gruntfile as a task.\r\n\r\n``` js\r\ngrunt.registerTask('setup', 'setup database', function() {\r\n  var userSetup = require('./node_modules/express-user-couchdb/init');\r\n  userSetup('http://localhost:5984/_users', function(err) {\r\n    console.log(\"configured express-user-couchdb module\");\r\n  });\r\n});\r\n```\r\n\r\nor you can invoke via command line\r\n\r\n``` sh\r\nnode ./node_modules/express-user-couchdb/init http://localhost:5984/_users\r\n```\r\n\r\n## API Commands\r\n\r\n### POST /api/user/signup\r\n\r\nCreate a new user account.  If config.verify is set, the user will be sent an email with a link to verify their account.\r\nIf the user trying to login has enabled set to false, they will be notified to contact an admin to reactivate their account.\r\n\r\n``` json\r\n{\r\n  \"name\": \"user\",\r\n  \"password\": \"password\",\r\n  \"email\": \"user@email.com\",\r\n  \"data\": {}\r\n}\r\n```\r\n\r\n### POST /api/user/signin\r\n\r\nAllow a user to log in.  If config.verify is set, then the user is required to validate their email address before logging in.\r\n\r\n``` json\r\n{\r\n  \"name\": \"user\",\r\n  \"password\": \"password\"\r\n}\r\n```\r\n\r\n### POST /api/user/signout\r\n\r\n``` json\r\n{\r\n  \"name\": \"user\"\r\n}\r\n```\r\n\r\n### GET /api/user/current\r\n\r\nThe currently logged in user.  Returns a 401 error if the user is not currently logged in.\r\n\r\n\r\n### POST /api/user/forgot\r\n\r\nIf the user trying to retrieve their password has enabled set to false, they will be notified to contact an admin to reactivate their account.\r\n\r\n``` json\r\n{\r\n  \"email\": \"user@email.com\"\r\n}\r\n```\r\n\r\n### POST /api/user/verify:email\r\n\r\nSend an email to a user that includes a verification code and link to verify their account.\r\n\r\n``` json\r\n{\r\n  \"name\": \"email\"\r\n}\r\n```\r\n\r\n### POST /api/user/verify/:code\r\n\r\nConfirm that a user's email address is valid using a previously generated verification code.\r\n\r\n### POST /api/user/reset\r\n\r\nReset a user's password (requires the code generated using /api/user/forgot).\r\n\r\n``` json\r\n{\r\n  \"name\": \"user\",\r\n  \"code\": \"code\"\r\n}\r\n```\r\n\r\n### GET /api/user?roles=foo,bar\r\n\r\nReturn a list of users matching the specified roles.\r\n\r\n[{ user... }, { user2... }]\r\n\r\n### POST /api/user\r\n\r\nCreate a new user.  If config.adminRoles is set, the user making this call must have one of the specified roles.\r\n\r\n``` json\r\n{\r\n  \"name\": \"user1\",\r\n  \"type\": \"user\",\r\n  \"password\": \"foo\",\r\n  \"roles\": ['admin']\r\n}\r\n```\r\n\r\n### GET /api/user/:name\r\n\r\nReturns the user whose name matches :name.\r\n\r\n``` json\r\n{\r\n  \"_id\": \"org.couchdb.user:user1\",\r\n  \"_rev\": \"1-123456\",\r\n  \"name\": \"user1\",\r\n  \"type\": \"user\",\r\n  \"password\": \"foo\",\r\n  \"roles\": ['admin']\r\n}\r\n```\r\n\r\n### PUT /api/user/:name\r\n\r\nUpdates the user specified by :name.  If config.adminRoles is set, then a user must have an admin role to be able to update anyone else's record.  Non-admins cannot update their own role information.\r\n\r\n``` json\r\n{\r\n  \"_id\": \"org.couchdb.user:user1\",\r\n  \"_rev\": \"1-123456\",\r\n  \"name\": \"user1\",\r\n  \"type\": \"user\",\r\n  \"password\": \"foo\",\r\n  \"roles\": ['admin']\r\n}\r\n```\r\n\r\n### DELETE /api/user/:name\r\n\r\nRemoves the specified user.  If config.adminRoles is set, then a user must have an admin role to be able to delete a user.\r\n\r\n``` json\r\n{\r\n  \"_id\": \"org.couchdb.user:user1\",\r\n  \"_rev\": \"1-123456\",\r\n  \"name\": \"user1\",\r\n  \"type\": \"user\",\r\n  \"password\": \"foo\",\r\n  \"roles\": ['admin']\r\n}\r\n```\r\n\r\n## Usage\r\n\r\n``` js\r\nvar user = require('express-user-couchdb');\r\nvar config = { \r\n  users: 'http://localhost:5984/_users', \r\n  email ....\r\n};\r\napp.config(function() {\r\n  // handle other requests first\r\n  app.use(express.router);\r\n  // handle core requests\r\n  app.use(user(config));\r\n});\r\n```\r\n\r\n``` json\r\nnode init.js [couchdb users db]\r\n```\r\n\r\n## setting up email templates\r\n\r\nexpress-user-couchdb has the capability to attach to an smtp server and send emails for certain user events.  And you have the ability to manipulate the e-mail templates.  \r\n\r\nexpress-user-couchdb uses the nodemailer and email-templates modules to perform the email process, but you need to pass in the config settings in the config argument of the module:\r\n\r\nHere is an example of the config settings:\r\n\r\n``` js\r\n{\r\n  couch: 'http://localhost:5984/_users',\r\n  email: {\r\n    service: 'SMTP',\r\n    SMTP: {\r\n      ....\r\n    },\r\n    templateDir: ....\r\n  }\r\n}\r\n```\r\n\r\nto setup the forgot password email template you need to create a folder called `forgot` in the email template directory, then in that folder you need to create a style.css, html.ejs, and text.ejs.  These files will be used to build your email template.  Here is an example of the text.ejs\r\n\r\n### Forgot Password\r\n\r\n``` html\r\nFoo App\r\n#######\r\n\r\nWe are sorry you forgot your password, in order to reset your password,  we need you to click the link below.\r\n\r\nCopy Link:\r\n\r\nhttp://fooapp.com/account/reset?code=<%= user.code %>\r\n\r\nand paste into your browsers url.\r\n\r\nThank you for supporting our application, please let us know if you have any questions or concerns.\r\n\r\nThanks\r\n\r\nThe Team\r\n```\r\n\r\n### confirm e-mail\r\n\r\nIf you plan to enable the users to register, you may want to send a confirmation email to them when they sign up.\r\n\r\nYou would follow the same steps above, but instead of creating a forgot folder, you would need to create a confirm folder and place your css, html.ejs, and text.ejs files.\r\n\r\n## Contribution\r\n\r\nPull requests are welcome.\r\n\r\n## License\r\n\r\nMIT\r\n\r\n## Support\r\n\r\nPlease add issues to the github repo.\r\n\r\n## Thanks\r\n\r\n* CouchDb Team\r\n* NodeJS Team\r\n* NodeMailier\r\n* Nano Team\r\n* Email-Templates\r\n\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}